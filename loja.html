<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Loja - MrStore</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url('https://i.imgur.com/sI8LmKe.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: white;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .product-list, .total {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 20px;
      border-radius: 10px;
      flex: 1;
      min-width: 300px;
    }
    .product {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      text-align: center;
    }
    .product img {
      max-width: 100%;
      height: auto;
      margin-bottom: 10px;
      max-height: 200px;
    }
    button {
      background-color: #FFD700;
      color: black;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h2>Bem-vindo, <span id="nome-usuario"></span>!</h2>
    <button onclick="logout()">Sair</button>
  </div>

  <div class="container">
    <div class="product-list" id="product-list">
      <h3>Produtos disponíveis</h3>
    </div>

    <div class="total">
      <h3>Total de Mrcoin: <span id="total-moedas">0</span></h3>
      <button onclick="ganharMoeda()">Ganhar 1 Mrcoin</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <script>
    const supabaseUrl = 'https://iydzusoiaikkvpnnkpbh.supabase.co'
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5ZHp1c29pYWlra3Zwbm5rcGJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyOTg1MzgsImV4cCI6MjA2Mzg3NDUzOH0.oThN1XatHGyr1ic0I1VY8v8GYf9UKjx8Pg2Rl6R4Du0'

    const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey)

    let usuarioAtual = null
    let moedas = 0
    let estoque = {}

    const produtos = [
      { id: 'bola-nike', nome: 'Bola da Nike', preco: 5000, img: 'https://static.netshoes.com.br/produtos/bola-de-futebol-campo-nike-mercurial-primeira-classe-20-21-pt/fp/33d5d14078/zoom/foto1.jpg' },
      { id: 'camisa-csgo', nome: 'Camisa oficial CS:GO', preco: 10000, img: 'https://images.lojaoficial.com.br/products/32525' },
      { id: 'camisa-atletico', nome: 'Camisa do Atlético-MG 2023', preco: 15000, img: 'https://images.lojaoficial.com.br/products/33904' }
    ]

    async function iniciar() {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
        window.location.href = 'index.html'
        return
      }

      usuarioAtual = user

      document.getElementById('nome-usuario').textContent = usuarioAtual.email

      await carregarDadosUsuario()
      mostrarProdutos()
      atualizarTotal()
    }

    async function carregarDadosUsuario() {
      // Buscar dados no Supabase (tabela 'usuarios')
      const { data, error } = await supabase
        .from('usuarios')
        .select('moedas, estoque')
        .eq('email', usuarioAtual.email)
        .single()

      if (error && error.code === 'PGRST116') {
        // Nenhum registro ainda, cria
        await supabase.from('usuarios').insert({ email: usuarioAtual.email, moedas: 0, estoque: {} })
        moedas = 0
        estoque = {}
        return
      }

      if (error) {
        alert('Erro ao carregar dados: ' + error.message)
        return
      }

      moedas = data.moedas ?? 0
      estoque = data.estoque ?? {}
    }

    function mostrarProdutos() {
      const container = document.getElementById('product-list')
      container.innerHTML = '<h3>Produtos disponíveis</h3>'

      produtos.forEach(prod => {
        const div = document.createElement('div')
        div.className = 'product'

        const qtdComprada = estoque[prod.id] ?? 0

        div.innerHTML = `
          <img src="${prod.img}" alt="${prod.nome}" />
          <strong>${prod.nome}</strong><br />
          Preço: ${prod.preco} Mrcoins<br />
          <button ${moedas < prod.preco ? 'disabled' : ''} onclick="comprar('${prod.id}')">
            Comprar
          </button><br/>
          <small>Quantidade: ${qtdComprada}</small>
        `
        container.appendChild(div)
      })
    }

    async function comprar(id) {
      const produto = produtos.find(p => p.id === id)
      if (!produto) return alert('Produto não encontrado.')

      if (moedas < produto.preco) return alert('Saldo insuficiente.')

      moedas -= produto.preco
      estoque[id] = (estoque[id] || 0) + 1

      await salvarDados()

      mostrarProdutos()
      atualizarTotal()
      alert(`Você comprou: ${produto.nome}!`)
    }

    function atualizarTotal() {
      document.getElementById('total-moedas').textContent = moedas
    }

    async function salvarDados() {
      const { error } = await supabase
        .from('usuarios')
        .update({ moedas: moedas, estoque: estoque })
        .eq('email', usuarioAtual.email)

      if (error) alert('Erro ao salvar dados: ' + error.message)
    }

    async function ganharMoeda() {
      moedas++
      await salvarDados()
      atualizarTotal()
      mostrarProdutos()
    }

    async function logout() {
      await supabase.auth.signOut()
      window.location.href = 'index.html'
    }

    iniciar()
  </script>
</body>
</html>
