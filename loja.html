<!-- loja.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loja - MrStore</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url('https://i.imgur.com/sI8LmKe.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: white;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .product-list, .total {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 20px;
      border-radius: 10px;
      flex: 1;
      min-width: 300px;
    }

    .product {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      text-align: center;
    }

    .product img {
      max-width: 100%;
      height: auto;
      margin-bottom: 10px;
      max-height: 200px;
    }

    button {
      background-color: #FFD700;
      color: black;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h2>Bem-vindo, <span id="nome-usuario"></span>!</h2>
    <button onclick="logout()">Sair</button>
  </div>

  <div class="container">
    <div class="product-list" id="product-list">
      <h3>Produtos disponíveis</h3>
    </div>
    <div class="total">
      <h3>Total de Mrcoin: <span id="total-moedas">0</span></h3>
      <button onclick="ganharMoeda()">Ganhar 1 Mrcoin</button>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBFiGU-blNt7XFO9cjYPoWaPP-c5EEItfc",
      authDomain: "mrstore-d429f.firebaseapp.com",
      projectId: "mrstore-d429f",
      storageBucket: "mrstore-d429f.appspot.com",
      messagingSenderId: "310913725702",
      appId: "1:310913725702:web:22775b2fa034b0697e1a87"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let userEmail = localStorage.getItem('usuario_logado');
    if (!userEmail) {
      window.location.href = 'index.html';
    } else {
      document.getElementById('nome-usuario').innerText = userEmail;
    }

    let moedas = 0;

    const produtos = [
      {
        id: 'bola-nike', nome: 'Bola da Nike', preco: 5000, img: 'https://static.netshoes.com.br/produtos/bola-de-futebol-campo-nike-merlin-cbf/14/HZM-2881-114/HZM-2881-114_zoom2.jpg'
      },
      {
        id: 'jogos', nome: 'Aula com jogos e brincadeiras', preco: 1000, img: 'https://2.bp.blogspot.com/-c68QkhR3hRc/UFcYdZ8ezrI/AAAAAAAACAQ/8nrWUMt3_iI/s1600/P%C3%A1tio+-+flores+(5).JPG'
      },
      {
        id: 'educacao', nome: 'Aula extra de Educação física', preco: 1000, img: 'https://jundiai.sp.gov.br/noticias/wp-content/uploads/sites/32/2018/11/emeb_marcos_gasparian-166.jpg'
      },
      {
        id: 'horta', nome: 'Aula interativa na horta', preco: 1000, img: 'https://2.bp.blogspot.com/-Lj4wkphotVI/U9Gf68lVWRI/AAAAAAAAAog/6DV5vfqTe4U/s1600/DSC08998.JPG'
      },
      {
        id: 'jogos-virtuais', nome: 'Aula com jogos virtuais', preco: 1000, img: 'https://img.freepik.com/fotos-gratis/criancas-da-escola-usando-tablet-digital-em-sala-de-aula_107420-57955.jpg?size=626&ext=jpg'
      },
      {
        id: 'balas', nome: 'Balas', preco: 10, img: 'https://a-static.mlcdn.com.br/800x560/pacote-bala-7-belo-framboesa-600g-arcor/produtosdemaquiagem/10761p/370cbc11ef578c1c36f9c6bc2996a45b.jpg'
      },
      {
        id: 'pirulito', nome: 'Pirulito', preco: 20, img: 'https://cdn.awsli.com.br/2500x2500/1957/1957771/produto/1047748409ee2f58d9d.jpg'
      },
      {
        id: 'cinema', nome: 'Cinema com pipoca na sala', preco: 1000, img: 'https://2.bp.blogspot.com/-goes4lu3wsQ/VTl7mzY2lpI/AAAAAAAAGR0/By2X6yTVvZk/s1600/crian%C3%A7as-filmes.jpg'
      }
    ];

    async function carregarProdutos() {
      const container = document.getElementById('product-list');
      const estoqueRef = db.collection('estoque').doc('global');
      const moedasRef = db.collection('usuarios').doc(userEmail);

      const [estoqueSnap, moedasSnap] = await Promise.all([
        estoqueRef.get(),
        moedasRef.get()
      ]);

      const estoque = estoqueSnap.exists ? estoqueSnap.data() : {};
      moedas = moedasSnap.exists ? moedasSnap.data().mrcoin || 0 : 0;

      atualizarTela();
      container.innerHTML = '';
      produtos.forEach(prod => {
        const est = estoque[prod.id] ?? 0;
        const desativado = est <= 0 ? 'disabled' : '';
        container.innerHTML += `
          <div class="product">
            <img src="${prod.img}" alt="${prod.nome}" />
            <h4>${prod.nome}</h4>
            <p>Preço: ${prod.preco} Mrcoin</p>
            <p id="estoque-${prod.id}">Estoque: ${est}</p>
            <button id="btn-${prod.id}" onclick="comprarProduto('${prod.id}', ${prod.preco})" ${desativado}>Comprar</button>
          </div>
        `;
      });
    }

    async function comprarProduto(id, preco) {
      const estoqueRef = db.collection('estoque').doc('global');
      const moedasRef = db.collection('usuarios').doc(userEmail);

      const [estoqueSnap, moedasSnap] = await Promise.all([
        estoqueRef.get(),
        moedasRef.get()
      ]);

      const estoque = estoqueSnap.data();
      const saldo = moedasSnap.data().mrcoin || 0;

      if (estoque[id] <= 0) {
        alert('Produto fora de estoque!');
        return;
      }

      if (saldo < preco) {
        alert('Você não tem Mrcoin suficiente!');
        return;
      }

      estoque[id]--;
      await estoqueRef.set(estoque);
      await moedasRef.set({ mrcoin: saldo - preco });

      alert('Compra realizada com sucesso!');
      carregarProdutos();
    }

    async function ganharMoeda() {
      moedas++;
      await db.collection('usuarios').doc(userEmail).set({ mrcoin: moedas });
      atualizarTela();
    }

    function atualizarTela() {
      document.getElementById('total-moedas').innerText = moedas;
    }

    function logout() {
      localStorage.removeItem('usuario_logado');
      window.location.href = 'index.html';
    }

    window.onload = carregarProdutos;
  </script>
</body>
</html>
